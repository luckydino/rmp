import{j as k}from"./chakra-xNcrfRXW.js";import{a1 as wt,an as Pt,ao as $t,N as _t,k as tt,l as O,ap as Bt,aq as Ht,ar as St,S as Kt,as as At,c as Tt,d as st,at as Z,au as J,av as lt,T as it,aw as kt,ax as Ct,ay as R,q as dt,t as ct,n as at,m as Wt,o as Et,r as ut,E as ht,v as xt,y as bt,U as Q,az as Ot,p as Rt,$ as Xt,A as mt,z as zt,a7 as nt,ak as Ft,al as Yt}from"./index-DDaGTErg.js";import{f as It,b as j}from"./react-D-_si4LB.js";import{u as H,e as Ut,i as Vt}from"./clipboard-CPl3vTx0.js";import{s as ft,u as Qt,f as Zt,F as qt,l as Gt,b as Jt,c as te}from"./master-manager-BvOOnUNi.js";import{m as yt}from"./misc-nodes-CMG-U0WY.js";const ee={[wt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[wt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ne=t=>{const e=ee[t];return e.at(Math.floor(Math.random()*e.length))},Nt=It("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:l})=>{const{token:o}=e().account;if(!o){u(Pt({cityName:t,names:[]}));return}const s=await fetch("".concat($t,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return _t.warn("Failed to fetch random station names",s.statusText),l(s.statusText);const c=await s.json();u(Pt({cityName:t,names:c}))}),Dt=It("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var h;const{stationNames:l}=e().runtime,o=l[t];if(((h=o==null?void 0:o.length)!=null?h:0)==0)return _t.debug("No random station names in cache, using fallback"),u(Nt({cityName:t})),Object.values(ne(t));const s=structuredClone(o),c=s.shift();return u(Pt({cityName:t,names:s})),s.length<3&&u(Nt({cityName:t})),Object.values(c)}),Lt=(t,e,u,l,o,s,c)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return Mt(t,e,u,l,o)?c<0?{x1:e,y1:u,x2:l,y2:o,offset:s.offsetFrom}:e===l?{x1:e+5*c,y1:u,x2:l+5*c,y2:o,offset:s.offsetFrom}:u===o?{x1:e,y1:u+5*c,x2:l,y2:o+5*c,offset:s.offsetFrom}:{x1:e+5*Math.SQRT1_2*c,y1:u+5*Math.SQRT1_2*c,x2:l+5*Math.SQRT1_2*c,y2:o+5*Math.SQRT1_2*c,offset:s.offsetFrom}:void 0;const[h,r]=[s.offsetFrom,s.offsetTo];for(let p=0;p<Math.PI;p+=Math.PI/8)for(let i=p,m=0;m<2;m++,i+=Math.PI){const[S,b,A,N]=[Math.sin(p)*h,Math.cos(p)*h,Math.sin(i)*r,Math.cos(i)*r];if(Mt(t,e+S,u+b,l+A,o+N))return{x1:e+S,y1:u+b,x2:l+A,y2:o+N,offset:0}}},Mt=(t,e,u,l,o)=>!!((e===l||u===o)&&[tt.Diagonal,tt.Perpendicular].includes(t)||Math.abs((o-u)/(l-e))===1&&[tt.Diagonal,tt.RotatePerpendicular].includes(t)),se=(t,e)=>{const u=[],l=[];return Object.values(e).forEach(o=>{var _;if(o.length===1){l.push(...o.map(f=>f.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(f=>t.getEdgeAttribute(f,"type")===s)){l.push(...o.map(f=>f.edge));return}const c=t.getEdgeAttribute(o.at(0),"style");if(!o.every(f=>t.getEdgeAttribute(f,"style")===c)){l.push(...o.map(f=>f.edge));return}const h={},r=new Set,p=new Set,i=Object.fromEntries(o.map(f=>{var d,P;const[D,a]=t.extremities(f);return h[D]=((d=h[D])!=null?d:0)+1,h[a]=((P=h[a])!=null?P:0)+1,r.add(D),p.add(a),[D,[f.edge,a]]})),m=Array.from(r).filter(f=>h[f]===1),S=Array.from(p).filter(f=>h[f]===1);if(m.length!==1||S.length!==1){l.push(...o.map(f=>f.edge));return}const b=m[0],A=S[0];if(b===A){l.push(...o.map(f=>f.edge));return}const N=[i[b][0]];let T=i[b][1];for(let f=1;f<o.length;f=f+1){const D=(_=i[T])==null?void 0:_.at(1);if(!D){l.push(...o.map(a=>a.edge));return}N.push(i[T][0]),T=D}if(T!==A||N.length!==o.length){l.push(...o.map(f=>f.edge));return}u.push(N)}),{allReconciledLines:u,danglingLines:l}},oe=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const u=e.map(o=>{var b,A,N;const[s,c]=t.extremities(o),h=t.getNodeAttributes(s),r=t.getNodeAttributes(c),{type:p,parallelIndex:i}=t.getEdgeAttributes(o),m=(b=t.getEdgeAttribute(o,p))!=null?b:O[p].defaultAttrs,S=Lt(p,h.x,h.y,r.x,r.y,m,i);if(S){const{x1:T,y1:_,x2:f,y2:D,offset:a}=S;return O[tt.Simple].generatePath(T,f,_,D,{offset:a})}return(N=(A=O[p])==null?void 0:A.generatePath(h.x,r.x,h.y,r.y,m))!=null?N:"M ".concat(h.x," ").concat(h.y," L ").concat(r.x," ").concat(r.y)});let l="".concat(u[0]," ");for(let o=1;o<e.length;o=o+1)l+=u[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return l},re=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ie=t=>{const e={},u=[],l={},o=[];for(const r of t.edgeEntries()){const[p,i,m,S]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],b=Lt(r.attributes.type,p,i,m,S,r.attributes[r.attributes.type],r.attributes.parallelIndex);if(!b){if(r.attributes.parallelIndex>=0){u.push(r);continue}}if(r.attributes.reconcileId!==""){const A=r.attributes.reconcileId;A in l?l[A].push(r):l[A]=[r];continue}if(b){const A=r.edge,N=r.attributes,{x1:T,y1:_,x2:f,y2:D,offset:a}=b;e[A]={id:A,attr:N,path:O[tt.Simple].generatePath(T,f,_,D,{offset:a})};continue}o.push(r)}const s=new Set;for(;u.length;){const r=u.pop();if(s.has(r.edge))continue;const{normal:p,parallel:i}=Bt(t,r);if(!i.length)continue;i.forEach(S=>s.add(S.edge)),o.push(...p);const m=Ht(i);for(const S of i){const b=S.edge;e[b]={id:S.edge,attr:S.attributes,path:m[b]}}}const{allReconciledLines:c,danglingLines:h}=se(t,l);for(const r of c){const p=oe(t,r);if(!p)continue;const i=r[0];e[i]={id:i,attr:t.getEdgeAttributes(i),path:p}}for(const r of h){const p=t.getEdgeAttributes(r),[i,m]=t.extremities(r),S=t.getNodeAttributes(i),b=t.getNodeAttributes(m);e[r]={id:r,attr:p,path:O[tt.Simple].generatePath(S.x,b.x,S.y,b.y,O[tt.Simple].defaultAttrs)}}for(const r of o){const p=r.edge,i=r.attributes.type,m=r.attributes,[S,b,A,N]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(i in O)){e[p]={id:p,attr:m,path:"M ".concat(S," ").concat(b," L ").concat(A," ").concat(N)};continue}e[p]={id:p,attr:m,path:O[i].generatePath(S,A,b,N,m[i])}}return Object.values(e).map(r=>({id:r.id,type:"line",line:r}))},jt=t=>{const{id:e,x:u,y:l,handlePointerDown:o,handlePointerMove:s,handlePointerUp:c}=t,h=j.useCallback(i=>o(e,i),[e,o]),r=j.useCallback(i=>s(e,i),[e,s]),p=j.useCallback(i=>c(e,i),[e,c]);return k.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(l-6.4,")scale(0.025)"),onPointerDown:h,onPointerMove:r,onPointerUp:p,style:{cursor:"move"},children:k.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ae=t=>{const{id:e,path:u,handlePointerDown:l}=t,o=j.useCallback(s=>l(e,s),[e,l]);return k.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},ce=j.memo(t=>{var r,p,i,m,S,b,A,N,T,_,f,D;const{elements:e,handlePointerDown:u,handlePointerMove:l,handlePointerUp:o,handleEdgePointerDown:s}=t,c=Object.fromEntries(Array.from({length:21},(a,d)=>[d-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const d=a.line.attr.type,P=a.line.attr.style,C=a.line.attr[P],x=(r=St[P])==null?void 0:r.preComponent;x&&c[a.line.attr.zIndex].pre.push(k.jsx(x,{id:a.id,type:d,path:a.line.path,styleAttrs:C,newLine:!1,handlePointerDown:s},"".concat(a.id,".pre")));const v=(i=(p=St[P])==null?void 0:p.component)!=null?i:ae;c[a.line.attr.zIndex].main.push(k.jsx(v,{id:a.id,type:d,path:a.line.path,styleAttrs:C,newLine:!1,handlePointerDown:s},a.id));const I=(m=St[P])==null?void 0:m.postComponent;I&&c[a.line.attr.zIndex].post.push(k.jsx(I,{id:a.id,type:d,path:a.line.path,styleAttrs:C,newLine:!1,handlePointerDown:s},"".concat(a.id,".post")))}else if(a.type==="station"){const d=a.station,P=d.type,C=(S=ft[P])==null?void 0:S.preComponent;C&&c[a.station.zIndex].pre.push(k.jsx(C,{id:a.id,x:d.x,y:d.y,attrs:d,handlePointerDown:u,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".pre")));const x=(A=(b=ft[P])==null?void 0:b.component)!=null?A:jt;c[a.station.zIndex].main.push(k.jsx(x,{id:a.id,x:d.x,y:d.y,attrs:d,handlePointerDown:u,handlePointerMove:l,handlePointerUp:o},a.id));const v=(N=ft[P])==null?void 0:N.postComponent;v&&c[a.station.zIndex].post.push(k.jsx(v,{id:a.id,x:d.x,y:d.y,attrs:d,handlePointerDown:u,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const d=a.miscNode,P=d.type,C=(T=yt[P])==null?void 0:T.preComponent;C&&c[a.miscNode.zIndex].pre.push(k.jsx(C,{id:a.id,x:d.x,y:d.y,attrs:d[P],handlePointerDown:u,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".pre")));const x=(f=(_=yt[P])==null?void 0:_.component)!=null?f:jt;c[a.miscNode.zIndex].main.push(k.jsx(x,{id:a.id,x:d.x,y:d.y,attrs:d[P],handlePointerDown:u,handlePointerMove:l,handlePointerUp:o},a.id));const v=(D=yt[P])==null?void 0:D.postComponent;v&&c[a.miscNode.zIndex].post.push(k.jsx(v,{id:a.id,x:d.x,y:d.y,attrs:d[P],handlePointerDown:u,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,d)=>(d-10).toString()).map(a=>[...c[a].pre,...c[a].main,...c[a].post]).flat()},(t,e)=>t.elements===e.elements),le=[...Object.values(Kt),At.Virtual,At.Master,At.LondonArrow],de=()=>{const t=Tt(),e=j.useRef(window.graph),u=()=>{t(dt()),t(ct()),t(xt(e.current.export()))},{telemetry:{project:l},preference:{autoParallel:o}}=st(x=>x.app),{svgViewBoxZoom:s,svgViewBoxMin:c}=st(x=>x.param),{selected:h,refresh:{nodes:r,edges:p},mode:i,active:m,keepLastPath:S,theme:b}=st(x=>x.runtime),[A,N]=j.useState({x:0,y:0}),[T,_]=j.useState({x:0,y:0}),f=H((x,v)=>{v.stopPropagation(),i==="select"&&t(Z("free"));const I=v.currentTarget,{x:B,y:$}=J(v);I.setPointerCapture(v.pointerId),N({x:B,y:$}),t(lt(x)),v.shiftKey?h.has(x)?t(kt(x)):t(Ct(x)):h.has(x)||t(it(new Set([x])))}),D=H((x,v)=>{const{x:I,y:B}=J(v);i==="free"&&m===x?(h.forEach($=>{e.current.hasNode($)&&e.current.updateNodeAttributes($,X=>({...X,x:R(X.x-(A.x-I)*s/100,v.altKey?1:5),y:R(X.y-(A.y-B)*s/100,v.altKey?1:5)}))}),t(dt()),t(ct())):i.startsWith("line")&&_({x:(A.x-I)*s/100,y:(A.y-B)*s/100})}),a=H((x,v)=>{if(i.startsWith("line")){S||t(Z("free"));const I=e.current.hasNode(m)&&le.includes(e.current.getNodeAttribute(m,"type"));["stn_core_","virtual_circle_"].forEach($=>{var ot,rt;const K=(rt=(ot=document.elementsFromPoint(v.clientX,v.clientY)[0].attributes)==null?void 0:ot.getNamedItem("id"))==null?void 0:rt.value,F=K==null?void 0:K.startsWith($);if(I&&F){const L=i.slice(5),Y="line_".concat(at(10)),[et,W]=[m,K.slice($.length)],U=o?Wt(e.current,L,et,W,"from"):-1;e.current.addDirectedEdgeWithKey(Y,et,W,{visible:!0,zIndex:0,type:L,[L]:structuredClone(O[L].defaultAttrs),style:Et.SingleColor,[Et.SingleColor]:{color:b},reconcileId:"",parallelIndex:U}),l&&ut.event(ht.ADD_LINE,{type:L})}}),t(ct()),t(xt(e.current.export()))}else if(i==="free"&&m){const{x:I,y:B}=J(v);A.x-I===0&&A.y-B===0||t(xt(e.current.export()))}t(lt(void 0))}),d=H((x,v)=>{if(v.stopPropagation(),v.shiftKey||t(bt()),v.shiftKey&&h.has(x)?t(kt(x)):t(Ct(x)),i.startsWith("station")||i.startsWith("misc-node-virtual")||i.startsWith("misc-node-master")){const I=v.clientX-document.getElementById("canvas").getBoundingClientRect().left,B=v.clientY-document.getElementById("canvas").getBoundingClientRect().top,$=i.startsWith("station"),X=at(10),K=$?"stn_".concat(X):"misc_node_".concat(X),F=$?i.slice(8):i.slice(10),{x:ot,y:rt}=Q(I,B,s,c),L=$?structuredClone(ft[F].defaultAttrs):structuredClone(yt[F].defaultAttrs);"color"in L&&(L.color=b),e.current.addNode(K,{visible:!0,zIndex:0,x:R(ot,5),y:R(rt,5),type:F,[F]:L});const Y=e.current.getEdgeAttributes(x),{zIndex:et,type:W,style:U}=Y,V=Y[W],pt=Y[U],[n,y]=e.current.extremities(x),g=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(at(10)),n,K,{visible:!0,zIndex:et,type:W,[W]:structuredClone(V),style:U,[U]:structuredClone(pt),reconcileId:"",parallelIndex:g}),e.current.addDirectedEdgeWithKey("line_".concat(at(10)),K,y,{visible:!0,zIndex:et,type:W,[W]:structuredClone(V),style:U,[U]:structuredClone(pt),reconcileId:"",parallelIndex:g}),e.current.dropEdge(x),u(),l&&(ut.event(ht.ADD_STATION,{type:F}),ut.event(ht.ADD_LINE,{type:W})),t(Z("free")),t(it(new Set([K])))}}),P=j.useMemo(()=>[...ie(e.current),...re(e.current)],[p,r]),C=Ot.component;return k.jsxs(k.Fragment,{children:[k.jsx(ce,{elements:P,handlePointerDown:f,handlePointerMove:D,handlePointerUp:a,handleEdgePointerDown:d}),i.startsWith("line")&&m&&m!=="background"&&k.jsx(C,{id:"line_create_in_progress___no_use",type:i.slice(5),path:O[i.slice(5)].generatePath(e.current.getNodeAttribute(m,"x"),e.current.getNodeAttribute(m,"x")-T.x,e.current.getNodeAttribute(m,"y"),e.current.getNodeAttribute(m,"y")-T.y,O[i.slice(5)].defaultAttrs),styleAttrs:{color:b},newLine:!0,handlePointerDown:()=>{}})]})},me=()=>{const t=Tt(),e=j.useRef(window.graph),u=()=>{t(dt()),t(ct()),t(xt(e.current.export()))};st(n=>n.account);const{telemetry:{project:l},preference:{randomStationsNames:o}}=st(n=>n.app),{svgViewBoxZoom:s,svgViewBoxMin:c}=st(n=>n.param),{mode:h,lastTool:r,active:p,selected:i,keepLastPath:m,theme:S,refresh:{nodes:b},masterNodesCount:A,parallelLinesCount:N}=st(n=>n.runtime),T=Qt(),{height:_,width:f}=Rt(T),D=!1,a=!1;j.useEffect(()=>{const n=Zt(e.current);Object.entries(n).filter(([y,g])=>g&&y in qt).forEach(([y])=>Gt(y))},[b]);const[d,P]=j.useState({x:0,y:0}),[C,x]=j.useState({x:0,y:0}),[v,I]=j.useState({x:0,y:0}),[B,$]=j.useState({x:0,y:0}),X=H(async n=>{const{x:y,y:g}=J(n);if(h.startsWith("station")){t(Z("free"));const M=at(10),E="stn_".concat(M),w=h.slice(8),z=structuredClone(ft[w].defaultAttrs);"color"in z&&(z.color=S);{const gt=await t(Dt(wt.Shmetro));if(Dt.fulfilled.match(gt)){const G=gt.payload;z.names.length>G.length?G.push(...Array(z.names.length-G.length).fill(G.at(-1))):z.names.length<G.length&&G.splice(z.names.length,G.length-z.names.length),z.names=G}}const{x:q,y:vt}=Q(y,g,s,c);e.current.addNode(E,{visible:!0,zIndex:0,x:R(q,5),y:R(vt,5),type:w,[w]:z}),u(),l&&ut.event(ht.ADD_STATION,{type:w}),t(it(new Set([E])))}else if(h.startsWith("misc-node")){t(Z("free"));const M=at(10),E="misc_node_".concat(M),w=h.slice(10),{x:z,y:q}=Q(y,g,s,c);e.current.addNode(E,{visible:!0,zIndex:0,x:R(z,5),y:R(q,5),type:w,[w]:structuredClone(yt[w].defaultAttrs)}),u(),l&&ut.event(ht.ADD_STATION,{type:w}),t(it(new Set([E])))}else h==="free"||h.startsWith("line")?(h.startsWith("line")&&(t(Z("free")),m&&t(Xt(!1))),I({x:y,y:g}),$(c),n.shiftKey||(t(lt("background")),t(bt()))):h==="select"&&(P(Q(y,g,s,c)),x(Q(y,g,s,c)))}),K=H(n=>{if(h==="select"){if(d.x!=0&&d.y!=0){const{x:y,y:g}=J(n);x(Q(y,g,s,c))}}else if(p==="background"){const{x:y,y:g}=J(n);t(mt({x:B.x+(v.x-y)*s/100,y:B.y+(v.y-g)*s/100}))}}),F=H(n=>{if(h==="select"){const{x:y,y:g}=J(n),{x:M,y:E}=Q(y,g,s,c),w=Jt(e.current,d.x,d.y,M,E),z=te(e.current,new Set(w));t(it(new Set([...n.shiftKey?i:[],...w,...z]))),t(Z("free")),P({x:0,y:0}),x({x:0,y:0})}p==="background"&&!n.shiftKey&&t(lt(void 0))}),ot=H(n=>{let y=s;n.deltaY>0&&s+10<400?y=s+10:n.deltaY<0&&s-10>0&&(y=s-10),t(zt(y));const{x:g,y:M}=J(n),E=n.currentTarget.getBoundingClientRect(),[w,z]=[g/E.width,M/E.height];t(mt({x:c.x+g*s/100-f*y/100*w,y:c.y+M*s/100-_*y/100*z}))}),rt=H(async n=>{if(nt?n.key==="Backspace":n.key==="Delete")i.size>0&&(i.forEach(y=>{e.current.hasNode(y)?e.current.dropNode(y):e.current.hasEdge(y)&&e.current.dropEdge(y)}),t(bt()),u());else if(n.key.startsWith("Arrow")){const g=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,M=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(mt(Q(100*g,100*M,s,c)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const g=(n.key==="j"?-1:n.key==="l"?1:0)*10,M=(n.key==="i"?-1:n.key==="k"?1:0)*10;i.size>0&&i.forEach(E=>{e.current.hasNode(E)&&(e.current.updateNodeAttribute(E,"x",w=>(w!=null?w:0)+g),e.current.updateNodeAttribute(E,"y",w=>(w!=null?w:0)+M),u())})}else if(n.key==="f"&&r)t(Z(r));else if(n.key==="z"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey))nt&&n.preventDefault(),t(Ft()),t(dt()),t(ct());else if(n.key==="s")t(Z("select"));else if((n.key==="c"||n.key==="x")&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const y=Ut(e.current,i);navigator.clipboard.writeText(y),n.key==="x"&&(t(bt()),i.forEach(g=>{e.current.hasNode(g)?e.current.dropNode(g):e.current.hasEdge(g)&&e.current.dropEdge(g)}),u())}else if(n.key==="v"&&(nt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const y=await navigator.clipboard.readText(),{x:g,y:M}=Q(f/2,_/2,s,c),{nodes:E,edges:w}=Vt(y,e.current,D,a,R(g,5),R(M,5));u();const z=structuredClone(E);w.forEach(q=>z.add(q)),t(it(z))}else(nt&&n.key==="z"&&n.metaKey&&n.shiftKey||!nt&&n.key==="y"&&n.ctrlKey)&&(t(Yt()),t(dt()),t(ct()))}),[L,Y]=j.useState(0),et=H(n=>{if(n.touches.length===2){t(lt(void 0));const[y,g]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];Y(y*y+g*g)}}),W=H(n=>{if(L!==0&&n.touches.length===2){const[y,g]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],M=y*y+g*g;let E=s;M-L<0&&s+10<=390?E=s+10:M-L>0&&s-10>=10&&(E=s-10),t(zt(E)),Y(M);const w=n.currentTarget.getBoundingClientRect(),[z,q]=[(n.touches[0].clientX+n.touches[1].clientX)/2-w.left,(n.touches[0].clientY+n.touches[1].clientY)/2-w.top],[vt,gt]=[z/w.width,q/w.height];t(mt({x:c.x+z*s/100-f*E/100*vt,y:c.y+q*s/100-_*E/100*gt}))}}),U=H(n=>{L!==0&&Y(0)}),[V,pt]=j.useState({sx:0,sy:0,ex:0,ey:0});return j.useEffect(()=>{pt({sx:d.x<=C.x?d.x:C.x,ex:d.x>C.x?d.x:C.x,sy:d.y<=C.y?d.y:C.y,ey:d.y>C.y?d.y:C.y})},[C.x,C.y]),k.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:_,width:f,viewBox:"".concat(c.x," ").concat(c.y," ").concat(f*s/100," ").concat(_*s/100),onPointerDown:X,onPointerMove:K,onPointerUp:F,onTouchStart:et,onTouchMove:W,onTouchEnd:U,onWheel:ot,tabIndex:0,onKeyDown:rt,children:[k.jsx(de,{}),h==="select"&&d.x!=0&&d.y!=0&&k.jsx("rect",{x:V.sx,y:V.sy,width:V.ex-V.sx,height:V.ey-V.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),k.jsx("defs",{children:k.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[k.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),k.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{me as default};
